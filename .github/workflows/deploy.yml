name: Deploy to Azure VM

on:
  push:
    branches:
      - main
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

# é˜²æ­¢å¹¶å‘éƒ¨ç½²
concurrency:
  group: production-deployment
  cancel-in-progress: false  # ä¸å–æ¶ˆæ­£åœ¨è¿è¡Œçš„ï¼Œæ–°çš„æ’é˜Ÿç­‰å¾…

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to Azure VM
        uses: appleboy/ssh-action@v1.0.0
        timeout-minutes: 20  # å¢åŠ è¶…æ—¶æ—¶é—´åˆ°20åˆ†é’Ÿ
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_KEY }}
          command_timeout: 20m  # SSHå‘½ä»¤è¶…æ—¶æ—¶é—´
          script: |
            echo "ğŸš€ Starting deployment..."
            
            # è¿›å…¥é¡¹ç›®ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨åˆ™å…‹éš†ï¼‰
            if [ ! -d "/opt/auto-score-analyzer" ]; then
              echo "ğŸ“¦ Cloning repository..."
              cd /opt
              sudo git clone https://github.com/aristo7298sub/auto-score-analyzer.git
              sudo chown -R $USER:$USER auto-score-analyzer
            fi
            
            cd /opt/auto-score-analyzer
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ Pulling latest code..."
            git pull origin main
            
            # æ£€æŸ¥.envæ–‡ä»¶
            if [ ! -f .env ]; then
              echo "âš ï¸ Warning: .env file not found. Please configure it manually."
              echo "Example: cp .env.example .env && nano .env"
            fi
            
            # åœæ­¢ç°æœ‰å®¹å™¨
            echo "ğŸ›‘ Stopping existing containers..."
            docker-compose down
            
            # é‡æ–°æ„å»ºå¹¶å¯åŠ¨
            echo "ğŸ”¨ Building and starting containers..."
            docker-compose up -d --build
            
            # ç­‰å¾…å¥åº·æ£€æŸ¥
            echo "â³ Waiting for services to be healthy..."
            sleep 30
            
            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            echo "ğŸ“Š Service status:"
            docker-compose ps
            
            # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
            echo "ğŸ§¹ Cleaning up unused images..."
            docker image prune -f
            
            echo "âœ… Deployment completed!"
            echo "ğŸŒ Application available at: http://40.81.16.161"
