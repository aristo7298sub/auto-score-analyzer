# 2025-12-15 开发总结（准备同步到 Hybrid / Cloud）

目标：完成“额度/Token 成本可视化 + 管理后台增强 + Quota 页面运营化”一整套能力，并在本地（Local-All）验证可用；明天把同一套代码/迁移同步到 Hybrid（本地代码+云端DB）与 Cloud（ACA）。

---

## 本次交付范围（按业务功能）

### 1) 全链路 tokens 采集、落库与展示
- 后端在每次分析（upload/批量分析）完成后，采集 Azure OpenAI `usage`：
  - `prompt_tokens`（Input）
  - `completion_tokens`（Generated）
- 写入 `analysis_logs` 表字段，并在管理后台按时间范围聚合展示。

### 2) 管理后台（Admin）增强
- 用户管理页：
  - 支持时间范围：`1d | 7d | 30d | custom(start_at + end_at)`（默认 7d）
  - 支持对“已用配额 / 推荐人数 / tokens(Input/Generated)”按当前时间范围排序（升/降）
  - 表格字体更紧凑、强制不换行，并启用横向滚动以避免竖排
- 数据概览页：新增“总tokens消耗”（全平台汇总 Input / Generated）。

### 3) 配额管理（Quota）页面重构与运营文案
- 移除 Quota 页“管理员：本月消耗排行”模块
- 合并“额度流水/任务明细”为单一“消耗明细（最近50条）”
  - 仅展示列：时间 / 消耗额度 / 剩余额度
  - 顶部展示汇总（所选时间范围内的任务数 + 总消耗）
  - 支持时间范围：`1d | 7d | 30d | custom(start_at + end_at)`
  - 切换到 custom 时不再先报错；直接显示开始/结束时间框，并预填默认值（过去7天 ~ 现在）
- 关键数值与 VIP 状态使用圆角方框背景突出（样式与全站主题一致）
- 计费规则文案更新：`1个学生成绩记录 = 1个额度 = 0.3元`
- 充值与 VIP：
  - 两个按钮同色
  - 中间分割线显示“OR”
  - 弹窗文案更新为“闲鱼”购买指引
  - 二维码支持 JPG（`frontend/public/payments/*.jpg`）
  - 删除二维码下方“替换图片提示文字”

---

## 后端变更（API / DB / 服务）

### 数据库 schema 变更
- `analysis_logs` 新增列：
  - `prompt_tokens` (int, default 0)
  - `completion_tokens` (int, default 0)

### 迁移与兼容
- Alembic 迁移：新增版本 `003_add_analysis_tokens.py`，用于给 `analysis_logs` 补两列。
- 启动兼容补列：`ensure_schema_compatibility()` 也会 best-effort 为旧库补列（主要用于本地 SQLite 兼容；生产/云端建议走 Alembic）。

### 新增/增强 API
- `GET /api/admin/users`
  - 新增 query：`time_range`, `start_at`, `end_at`
  - 返回每个用户的时间范围聚合字段：
    - `range_quota_used`
    - `range_referral_count`
    - `range_prompt_tokens`
    - `range_completion_tokens`

- `GET /api/admin/stats`
  - 新增返回字段（全平台，成功任务汇总）：
    - `total_prompt_tokens`
    - `total_completion_tokens`

- `GET /api/quota/consumption`
  - query：`limit`, `offset`, `time_range`, `start_at`, `end_at`
  - 仅统计 `transaction_type == analysis_cost`
  - 返回：
    - `items`: 最近 N 条消耗记录
    - `summary`: 时间范围汇总（任务数 + 总消耗）

### AOAI usage 采集写入
- 分析服务从 AOAI response 中读取 `usage.prompt_tokens / usage.completion_tokens`，并在 upload 成功后写入 `analysis_logs`。

---

## 前端变更（页面与样式）

### Admin 页面
- 数据概览新增：总tokens消耗（Input / Generated）
- 用户管理：
  - 时间范围新增 custom 结束时间选择
  - 已用配额/推荐人数/tokens 允许排序
  - 表格字体缩小、强制不换行、启用横向滚动

### Quota 页面
- 页面运营文案与按钮文案调整
- 关键数字与 VIP 状态：圆角方框背景（使用全站主题变量）
- 消耗明细合并并支持自定义起止时间
- 充值&VIP：分割线显示 OR；弹窗文案改为闲鱼；二维码改为 JPG；删除提示文字

---

## 资源文件（二维码）

已适配 JPG：
- `frontend/public/payments/quota-topup.jpg`
- `frontend/public/payments/vip-month.jpg`

---

## 本地测试辅助（仅用于开发验证）

- 脚本：`backend/scripts/seed_fake_logs.py`
  - 用途：向本地 DB 写入 fake users / analysis logs / analysis_cost 交易，便于验证 Admin/Quota UI
  - 注意：这是开发辅助脚本，不需要在 Cloud 环境运行。

---

## 明天同步到 Hybrid（Local code + Cloud DB）的步骤

> 前提：你已准备好 Hybrid 使用的云端 PostgreSQL 连接串，并放在本机 `backend/.env`（不要提交）。

1) 切换后端 DB 到云端 PostgreSQL
- 参考：`backend/.env.clouddb.example`
- 设置：`DATABASE_URL=postgresql+psycopg2://...`

2) 执行 DB 迁移（建议必做）
- 重点：给 `analysis_logs` 增加 tokens 两列
- 建议命令（在 backend 目录）：
  - `alembic upgrade head`

3) 验收（Hybrid）
- Admin
  - 数据概览：应看到总 tokens（Input/Generated）
  - 用户管理：切换 1d/7d/30d/custom(start/end) 不报错；排序正常
- Quota
  - 数值/VIP 显示有圆角背景
  - “自定义起止”直接出现开始/结束时间框
  - “OR” 分割线存在
  - 两个弹窗文案为“闲鱼”，二维码正常显示（JPG）

风险提示（Hybrid）：
- 此模式会直接写云端真实数据；请用专用测试账号。

---

## 明天同步到 Cloud（Azure Container Apps）的步骤

1) 确认前端静态资源被打包
- 需要确认容器构建会包含 `frontend/public/payments/*.jpg`（Vite 默认会打包/拷贝 public 目录）。

2) 云端 DB schema
- 如果 Cloud 环境使用 Alembic：部署前/部署后执行 `alembic upgrade head`
- 如果 Cloud 环境不跑 Alembic：需要通过一次性迁移任务或手动 SQL 增加列
  - `analysis_logs.prompt_tokens` / `analysis_logs.completion_tokens`（默认 0）

3) Cloud 验收清单
- 与 Hybrid 验收一致，额外关注：
  - CORS / 反向代理是否影响 `/api/quota/consumption`、`/api/admin/stats`、`/api/admin/users` 查询
  - Quota 弹窗二维码在生产域名下是否能加载 `payments/*.jpg`

---

## 关键文件清单（便于 code review / 发布时快速定位）

后端：
- `backend/app/models/user.py`（AnalysisLog 新增 tokens 字段）
- `backend/app/services/analysis_service.py`（解析 usage）
- `backend/app/api/endpoints.py`（upload 写入 tokens）
- `backend/app/api/admin.py`（/admin/users 时间聚合；/admin/stats tokens 汇总）
- `backend/app/api/quota.py`（新增 /quota/consumption）
- `backend/app/schemas/user_schemas.py`（AdminStats/AdminUserListItem/consumption schemas）
- `backend/app/core/database.py`（ensure_schema_compatibility 补列）
- `backend/alembic/versions/003_add_analysis_tokens.py`

前端：
- `frontend/src/pages/Admin.tsx`
- `frontend/src/pages/Quota.tsx`
- `frontend/src/services/apiClient.ts`
- `frontend/src/styles/admin.css`
- `frontend/src/styles/quota.css`
- `frontend/public/payments/quota-topup.jpg`
- `frontend/public/payments/vip-month.jpg`

---

## 备注（安全与提交）
- 不要提交任何 `.env`、真实连接串、AOAI key。
- 不要提交本地 DB 文件、uploads/exports 等数据目录。
